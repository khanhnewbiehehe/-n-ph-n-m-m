@model QLThuCung.Models.HoaDonDichVu

<div class="container">
    <div class="mt-5 pt-3"></div>

    <div class="card card-invoice mx-auto shadow">
        <div class="card-header">
            CHỈNH SỬA HÓA ĐƠN
        </div>
        <div class="card-body">
            <form asp-action="Edit" asp-route-id="@Model.Id" method="post" asp-area="Admin" asp-controller="HoaDonDichVuAD">
                <div class="card shadow list-thongtin p-4 mt-2">
                    <div class="mini-cardsubtitle card">Thông tin chung</div>
                    <div class="form-group">
                        <input type="hidden" asp-for="NguoiTao" class="form-control" value="@ViewBag.NguoiTao" />
                    </div>
                    <div class="form-group">
                        <label asp-for="IdThuCung" class="control-label">Thú cưng</label>
                        <select asp-for="IdThuCung" id="ComboBoxThuCung" class="form-control">
                            @foreach (var thuCung in ViewBag.ThuCungs)
                            {
                                <option value="@thuCung.Id" selected="@(thuCung.Id == Model.IdThuCung)">@thuCung.Ten</option>
                            }
                        </select>
                        <input type="hidden" asp-for="IdThuCung" />
                        <span asp-validation-for="IdThuCung" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="NgayChamSoc" class="control-label"></label>
                        <input asp-for="NgayChamSoc" class="form-control" type="date" />
                        <span asp-validation-for="NgayChamSoc" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="ThoiGianChamSoc" class="control-label"></label>
                        <input type="hidden" name="ThoiGianChamSocDB" id="ThoiGianChamSocDB" value="@ViewBag.ThoiGianChamSocDB" />
                        <select asp-for="ThoiGianChamSoc" id="ThoiGianChamSoc" class="form-control" required>
                            <option value="0">Chọn giờ đến</option>
                            <option value="420" selected="@(Model.ThoiGianChamSoc == 420)">7:00</option>
                            <option value="450" selected="@(Model.ThoiGianChamSoc == 450)">7:30</option>
                            <option value="480" selected="@(Model.ThoiGianChamSoc == 480)">8:00</option>
                            <option value="510" selected="@(Model.ThoiGianChamSoc == 510)">8:30</option>
                            <option value="540" selected="@(Model.ThoiGianChamSoc == 540)">9:00</option>
                            <option value="570" selected="@(Model.ThoiGianChamSoc == 570)">9:30</option>
                            <option value="600" selected="@(Model.ThoiGianChamSoc == 600)">10:00</option>
                            <option value="780" selected="@(Model.ThoiGianChamSoc == 780)">13:00</option>
                            <option value="810" selected="@(Model.ThoiGianChamSoc == 810)">13:30</option>
                            <option value="840" selected="@(Model.ThoiGianChamSoc == 840)">14:00</option>
                            <option value="870" selected="@(Model.ThoiGianChamSoc == 870)">14:30</option>
                            <option value="900" selected="@(Model.ThoiGianChamSoc == 900)">15:00</option>
                            <option value="930" selected="@(Model.ThoiGianChamSoc == 930)">15:30</option>
                            <option value="960" selected="@(Model.ThoiGianChamSoc == 960)">16:00</option>
                        </select>
                        <span asp-validation-for="ThoiGianChamSoc" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="PhuongThucThanhToan" class="control-label"></label>
                        <select asp-for="PhuongThucThanhToan" class="form-control">
                            <option value="0" selected="@(Model.PhuongThucThanhToan == 0)">Trả sau</option>
                            <option value="1" selected="@(Model.PhuongThucThanhToan == 1)">VNPAY</option>
                        </select>
                        <span asp-validation-for="PhuongThucThanhToan" class="text-danger"></span>
                    </div>
                </div>

                <div class="card shadow p-4 my-4">
                    <div class="mini-cardsubtitle card">Trạng thái</div>
                    <div class="form-group status-container">
                        <div class="form-check">
                            <input type="radio" asp-for="TrangThai" value="0" class="form-check-input status-radio" id="status_0" />
                            <label class="form-check-label" for="status_0">Chờ xử lý</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" asp-for="TrangThai" value="4" class="form-check-input status-radio" id="status_4" />
                            <label class="form-check-label" for="status_4">Không đến</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" asp-for="TrangThai" value="1" class="form-check-input status-radio" id="status_1" />
                            <label class="form-check-label" for="status_1">Đã xử lý</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" asp-for="TrangThai" value="2" class="form-check-input status-radio" id="status_2" />
                            <label class="form-check-label" for="status_2">Chờ thanh toán</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" asp-for="TrangThai" value="3" class="form-check-input status-radio" id="status_3" />
                            <label class="form-check-label" for="status_3">Hoàn thành</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" asp-for="TrangThai" value="-1" class="form-check-input status-radio" id="status_-1" />
                            <label class="form-check-label" for="status_-1">Hủy</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" asp-for="TrangThai" value="-100" class="form-check-input status-radio" id="status_-100" />
                            <label class="form-check-label" for="status_-100">Không xác định</label>
                        </div>
                        <input type="hidden" id="BatDau" name="BatDau" value="@(ViewBag.BatDau != null ? ViewBag.BatDau : "" )" />
                        <input type="hidden" id="KetThuc" name="KetThuc" value="@(ViewBag.KetThuc != null ? ViewBag.KetThuc : "" )" />
                    </div>
                </div>

                <div class="card shadow p-4 my-4">
                    <div class="mini-cardsubtitle card">Danh sách dịch vụ</div>
                    <div class="mt-3">
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="#3c57d2" width="16px" class="me-1" viewBox="0 0 512 512">
                                <path d="M16 232l0 48c0 13.3 10.7 24 24 24l48 0c13.3 0 24-10.7 24-24l0-48c0-13.3-10.7-24-24-24l-48 0c-13.3 0-24 10.7-24 24zM40 368c-13.3 0-24 10.7-24 24l0 48c0 13.3 10.7 24 24 24l48 0c13.3 0 24-10.7 24-24l0-48c0-13.3-10.7-24-24-24l-48 0zM64 32C28.7 32 0 60.7 0 96l0 32 576 0 0-32c0-35.3-28.7-64-64-64L64 32zM576 224L0 224 0 416c0 35.3 28.7 64 64 64l448 0c35.3 0 64-28.7 64-64l0-192zM112 352l64 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-64 0c-8.8 0-16-7.2-16-16s7.2-16 16-16zm112 16c0-8.8 7.2-16 16-16l128 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-128 0c-8.8 0-16-7.2-16-16zM192 64c-17.7 0-32 14.3-32 32s14.3 32 32 32l288 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L192 64zm0 160c-17.7 0-32 14.3-32 32s14.3 32 32 32l288 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-288 0zm0 160c-17.7 0-32 14.3-32 32s14.3 32 32 32l288 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-288 0z" />
                            </svg>
                            <strong>Dịch vụ</strong>
                        </div>
                        <div id="ListCheckBoxDichVu" class="mt-2">
                        </div>
                        <p class="mt-3" id="EstimateTime"></p>
                        <span id="dichVuValidation" class="text-danger"></span>
                    </div>
                    <div class="mt-3">
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="#3c57d2" width="16px" class="me-1" viewBox="0 0 512 512">
                                <path d="M512 80c0 18-14.3 34.6-38.4 48c-29.1 16.1-72.5 27.5-122.3 30.9c-3.7-1.8-7.4-3.5-11.3-5C300.6 137.4 248.2 128 192 128c-8.3 0-16.4 .2-24.5 .6l-1.1-.6C142.3 114.6 128 98 128 80c0-44.2 86-80 192-80S512 35.8 512 80zM160.7 161.1c10.2-.7 20.7-1.1 31.3-1.1c62.2 0 117.4 12.3 152.5 31.4C369.3 204.9 384 221.7 384 240c0 4-.7 7.9-2.1 11.7c-4.6 13.2-17 25.3-35 35.5c0 0 0 0 0 0c-.1 .1-.3 .1-.4 .2c0 0 0 0 0 0s0 0 0 0c-.3 .2-.6 .3-.9 .5c-35 19.4-90.8 32-153.6 32c-59.6 0-112.9-11.3-148.2-29.1c-1.9-.9-3.7-1.9-5.5-2.9C14.3 274.6 0 258 0 240c0-34.8 53.4-64.5 128-75.4c10.5-1.5 21.4-2.7 32.7-3.5zM416 240c0-21.9-10.6-39.9-24.1-53.4c28.3-4.4 54.2-11.4 76.2-20.5c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 19.3-16.5 37.1-43.8 50.9c-14.6 7.4-32.4 13.7-52.4 18.5c.1-1.8 .2-3.5 .2-5.3zm-32 96c0 18-14.3 34.6-38.4 48c-1.8 1-3.6 1.9-5.5 2.9C304.9 404.7 251.6 416 192 416c-62.8 0-112.9-12.6-153.6-32C14.3 370.6 0 354 0 336l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 342.6 135.8 352 192 352s108.6-9.4 148.1-25.9c7.8-3.2 15.3-6.9 22.4-10.9c6.1-3.4 11.8-7.2 17.2-11.2c1.5-1.1 2.9-2.3 4.3-3.4l0 3.4 0 5.7 0 26.3zm32 0l0-32 0-25.9c19-4.2 36.5-9.5 52.1-16c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 10.5-5 21-14.9 30.9c-16.3 16.3-45 29.7-81.3 38.4c.1-1.7 .2-3.5 .2-5.3zM192 448c56.2 0 108.6-9.4 148.1-25.9c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 44.2-86 80-192 80S0 476.2 0 432l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 438.6 135.8 448 192 448z" />
                            </svg>
                            <strong>Tổng tiền: </strong>
                        </div>
                        <p id="TotalPrice"></p>
                    </div>
                    <div id="listDichVuInput"></div>
                </div>

                <div class="card-footer">
                    <button type="submit" class="btn btn-primary" id="saveButton" >Lưu</button>
                    <a asp-action="Details" asp-route-id="@Model.Id" asp-route-area="Admin" asp-controller="HoaDonDichVuAD" class="btn btn-secondary" id="cancelButton">Hủy</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts
{
    
    <script>
        
        let idDichVu = @Json.Serialize(ViewBag.SelectedDichVuIds);
        $(document).ready(function () {
            $('#ComboBoxThuCung').prop('disabled', true);
            let currentStatus = @Model.TrangThai;
            LoadCBDichVu2();
            
            let selectedDate = $("#NgayChamSoc").val();
            if (selectedDate) {
                $.ajax({
                    url: `/admin/datlich/listbydate/${selectedDate}`,
                    method: 'GET',
                    
                    success: function (response) {
                        if (response && response.data) {
                            hoaDonsData = response.data;
                            setTimeout(function () {
                                $('.dichvu-checkbox').each(function () {
                                    const checkboxValue = parseInt($(this).val());
                                    if (idDichVu.includes(checkboxValue)) {
                                        $(this).prop('checked', true).trigger('checkboxChanged');
                                    }
                                });
                                updateEstimateTime();
                                updateTotalPrice();
                                disableBusyTimes(hoaDonsData);
                            }, 500);
                        } else {
                            console.error('Dữ liệu trả về không hợp lệ.');
                        }
                    },
                    error: function () {
                        console.error('Lỗi khi lấy danh sách hóa đơn.');
                    }
                });
            }

            if (currentStatus == 1) { // Đã xử lý
                $('#status_0').prop('disabled', true); 
                $('#status_4').prop('disabled', true); 
            } else if (currentStatus == 2) {
                $('#ListCheckBoxDichVu').css('pointer-events', 'none');
                $('#status_1').prop('disabled', true);
                $('#status_0').prop('disabled', true);
                $('#status_4').prop('disabled', true);
                $('#status_-100').prop('disabled', true);
                $('#NgayChamSoc').prop('disabled', true);
                $('#ThoiGianChamSoc').prop('disabled', true);
            } else if (currentStatus == 3 || currentStatus == -1) {
                $('#ListCheckBoxDichVu').css('pointer-events', 'none');
                $('input, select, textarea, .status-radio, .dichvu-checkbox').prop('disabled', true);
                $('#saveButton').prop('disabled', true).css('opacity', '0.5');
                $('#cancelButton').prop('disabled', false).css('opacity', '1');
            } 

            $('.status-radio').each(function () {
                const radioValue = parseInt($(this).val());
                if (radioValue === currentStatus) {
                    $(this).prop('checked', true);
                }
            });

            $('.status-radio').on('change', function () {
                let selectedStatus = $(this).val();
                if (selectedStatus) {
                    $('#TrangThai').val(selectedStatus);
                    if (selectedStatus == 1) {
                        let now = new Date();
                        let time = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
                        $('#BatDau').val(time);
                    } else if (selectedStatus == 2) {
                        let now = new Date();
                        let time = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
                        $('#KetThuc').val(time);
                    }
                }
            });

            $('form').on('submit', function () {
                updateHiddenInput();
            });

            $('form').validate({
                rules: {
                    "ChiTietHoaDonDichVu[0].IdDichVu": {
                        required: true
                    }
                },
                messages: {
                    "ChiTietHoaDonDichVu[0].IdDichVu": "Vui lòng chọn ít nhất một dịch vụ!"
                },
                errorPlacement: function (error, element) {
                    if (element.attr("name").startsWith("ChiTietHoaDonDichVu")) {
                        error.appendTo('#dichVuValidation');
                    } else {
                        error.insertAfter(element);
                    }
                },
                submitHandler: function (form) {
                    idDichVu = [];
                    $('.dichvu-checkbox:checked').each(function () {
                        idDichVu.push(parseInt($(this).attr('value')));
                    });

                    console.log('idDichVu:', idDichVu);
                    const listHiddenInput = $('#listDichVuInput');
                    listHiddenInput.empty();
                    idDichVu.forEach((id, index) => {
                        listHiddenInput.append(`
                            <input type="hidden" name="ChiTietHoaDonDichVu[${index}].IdDichVu" value="${id}" />
                        `);
                    });

                    form.submit();
                }
            });

            $('.dichvu-checkbox').on('checkboxChanged', function () {
                updateEstimateTime();
                updateTotalPrice();
                updateHiddenInput();
                disableBusyTimes(hoaDonsData);
            });

        });
    </script>
    <script src="~/LoadData/LoadThoiGianBanAD.js"></script>
    <script src="~/LoadData/LoadCBDichVu2.js"></script>
}