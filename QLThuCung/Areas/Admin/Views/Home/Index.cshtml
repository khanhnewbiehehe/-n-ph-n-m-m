<div class="container pt-3">
    <div class="d-flex justify-content-between align-items-center">
        <div class="card shadow mx-3 p-3 w-25 bg-primary">
            <div class="card-body card shadow p-4 bg-light">
                <strong>
                    <span class="text-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#0d6cf8" class="me-3" width="30px" height="30px" viewBox="0 0 576 512">
                            <path d="M0 24C0 10.7 10.7 0 24 0L69.5 0c22 0 41.5 12.8 50.6 32l411 0c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3l-288.5 0 5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5L488 336c13.3 0 24 10.7 24 24s-10.7 24-24 24l-288.3 0c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5L24 48C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z" />
                        </svg>
                        Sản phẩm:
                    </span> @ViewBag.SoLuongSanPham 
                </strong>
            </div>
        </div>
        <div class="card shadow  mx-3 p-3 w-25 bg-success">
            <div class="card-body card shadow p-4 bg-light">
                <strong>
                    <span class="text-success">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#198654" class="me-3" width="30px" height="30px" viewBox="0 0 512 512">
                            <path d="M152.1 38.2c9.9 8.9 10.7 24 1.8 33.9l-72 80c-4.4 4.9-10.6 7.8-17.2 7.9s-12.9-2.4-17.6-7L7 113C-2.3 103.6-2.3 88.4 7 79s24.6-9.4 33.9 0l22.1 22.1 55.1-61.2c8.9-9.9 24-10.7 33.9-1.8zm0 160c9.9 8.9 10.7 24 1.8 33.9l-72 80c-4.4 4.9-10.6 7.8-17.2 7.9s-12.9-2.4-17.6-7L7 273c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l22.1 22.1 55.1-61.2c8.9-9.9 24-10.7 33.9-1.8zM224 96c0-17.7 14.3-32 32-32l224 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-224 0c-17.7 0-32-14.3-32-32zm0 160c0-17.7 14.3-32 32-32l224 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-224 0c-17.7 0-32-14.3-32-32zM160 416c0-17.7 14.3-32 32-32l288 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-288 0c-17.7 0-32-14.3-32-32zM48 368a48 48 0 1 1 0 96 48 48 0 1 1 0-96z" />
                        </svg>
                        Dịch vụ:
                    </span> @ViewBag.SoLuongDichVu 
                </strong>
            </div>
        </div>
        <div class="card shadow  mx-3 p-3 w-25 bg-warning">
            <div class="card-body card shadow p-4 bg-light">
                <strong>
                    <span class="text-warning">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#fcbe07" class="me-3" width="30px" height="30px" viewBox="0 0 448 512">
                            <path d="M96 128a128 128 0 1 0 256 0A128 128 0 1 0 96 128zm94.5 200.2l18.6 31L175.8 483.1l-36-146.9c-2-8.1-9.8-13.4-17.9-11.3C51.9 342.4 0 405.8 0 481.3c0 17 13.8 30.7 30.7 30.7l131.7 0c0 0 0 0 .1 0l5.5 0 112 0 5.5 0c0 0 0 0 .1 0l131.7 0c17 0 30.7-13.8 30.7-30.7c0-75.5-51.9-138.9-121.9-156.4c-8.1-2-15.9 3.3-17.9 11.3l-36 146.9L238.9 359.2l18.6-31c6.4-10.7-1.3-24.2-13.7-24.2L224 304l-19.7 0c-12.4 0-20.1 13.6-13.7 24.2z" />
                        </svg>
                        Nhân viên:
                    </span> @ViewBag.SoLuongNhanVien 
                </strong>
            </div>
        </div>
        <div class="card shadow  mx-3 p-3 w-25 bg-danger">
            <div class="card-body card shadow p-4 bg-light">
                <strong>
                    <span class="text-danger">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#da3544" class="me-3" width="30px" height="30px" viewBox="0 0 640 512">
                            <path d="M224 0a128 128 0 1 1 0 256A128 128 0 1 1 224 0zM178.3 304l91.4 0c11.8 0 23.4 1.2 34.5 3.3c-2.1 18.5 7.4 35.6 21.8 44.8c-16.6 10.6-26.7 31.6-20 53.3c4 12.9 9.4 25.5 16.4 37.6s15.2 23.1 24.4 33c15.7 16.9 39.6 18.4 57.2 8.7l0 .9c0 9.2 2.7 18.5 7.9 26.3L29.7 512C13.3 512 0 498.7 0 482.3C0 383.8 79.8 304 178.3 304zM436 218.2c0-7 4.5-13.3 11.3-14.8c10.5-2.4 21.5-3.7 32.7-3.7s22.2 1.3 32.7 3.7c6.8 1.5 11.3 7.8 11.3 14.8l0 30.6c7.9 3.4 15.4 7.7 22.3 12.8l24.9-14.3c6.1-3.5 13.7-2.7 18.5 2.4c7.6 8.1 14.3 17.2 20.1 27.2s10.3 20.4 13.5 31c2.1 6.7-1.1 13.7-7.2 17.2l-25 14.4c.4 4 .7 8.1 .7 12.3s-.2 8.2-.7 12.3l25 14.4c6.1 3.5 9.2 10.5 7.2 17.2c-3.3 10.6-7.8 21-13.5 31s-12.5 19.1-20.1 27.2c-4.8 5.1-12.5 5.9-18.5 2.4l-24.9-14.3c-6.9 5.1-14.3 9.4-22.3 12.8l0 30.6c0 7-4.5 13.3-11.3 14.8c-10.5 2.4-21.5 3.7-32.7 3.7s-22.2-1.3-32.7-3.7c-6.8-1.5-11.3-7.8-11.3-14.8l0-30.5c-8-3.4-15.6-7.7-22.5-12.9l-24.7 14.3c-6.1 3.5-13.7 2.7-18.5-2.4c-7.6-8.1-14.3-17.2-20.1-27.2s-10.3-20.4-13.5-31c-2.1-6.7 1.1-13.7 7.2-17.2l24.8-14.3c-.4-4.1-.7-8.2-.7-12.4s.2-8.3 .7-12.4L343.8 325c-6.1-3.5-9.2-10.5-7.2-17.2c3.3-10.6 7.7-21 13.5-31s12.5-19.1 20.1-27.2c4.8-5.1 12.4-5.9 18.5-2.4l24.8 14.3c6.9-5.1 14.5-9.4 22.5-12.9l0-30.5zm92.1 133.5a48.1 48.1 0 1 0 -96.1 0 48.1 48.1 0 1 0 96.1 0z" />
                        </svg>
                        Kỹ thuật viên:
                    </span> @ViewBag.SoLuongKyThuatVien 
                </strong>
            </div>
        </div>
    </div>
    <div class="container pt-5">
        <div class="card shadow p-5">
            <div class="d-flex justify-content-between align-items-center mb-3 pb-3" style="border-bottom: 3px solid #3c57d2;">
                <div>
                    <h2 style="color:#3c57d2;"><strong>DOANH THU</strong></h2>
                </div>
                <button class="btn btn-primary">Xuất báo cáo</button>
            </div>
            <div class="filter-container card shadow d-flex flex-row justify-content-center mb-5 py-3">
                <div class="mx-3">
                    <label for="yearFilter" style="color:#3c57d2;"><strong>Năm:</strong></label>
                    <select class="form-control" style="width: 150px;" id="yearFilter">
                        <option value="all">Tất cả</option>
                    </select>
                </div>
                <div class="mx-3">
                    <label for="quarterFilter" style="color:#3c57d2;"><strong>Quý:</strong></label>
                    <select class="form-control" style="width: 150px;" id="quarterFilter">
                        <option value="all">Tất cả</option>
                        <option value="1">Quý 1</option>
                        <option value="2">Quý 2</option>
                        <option value="3">Quý 3</option>
                        <option value="4">Quý 4</option>
                    </select>
                </div>
                <div class="mx-3">
                    <label for="monthFilter" style="color:#3c57d2;"><strong>Tháng:</strong></label>
                    <select class="form-control" style="width: 150px;" id="monthFilter">
                        <option value="all">Tất cả</option>
                        <option value="1">Tháng 1</option>
                        <option value="2">Tháng 2</option>
                        <option value="3">Tháng 3</option>
                        <option value="4">Tháng 4</option>
                        <option value="5">Tháng 5</option>
                        <option value="6">Tháng 6</option>
                        <option value="7">Tháng 7</option>
                        <option value="8">Tháng 8</option>
                        <option value="9">Tháng 9</option>
                        <option value="10">Tháng 10</option>
                        <option value="11">Tháng 11</option>
                        <option value="12">Tháng 12</option>
                    </select>
                </div>
                <div class="mx-3">
                    <label for="typeFilter" style="color:#3c57d2;"><strong>Loại:</strong></label>
                    <select class="form-control" style="width: 150px;" id="typeFilter">
                        <option value="all">Tất cả</option>
                        <option value="Dịch vụ">Dịch vụ</option>
                        <option value="Sản phẩm">Sản phẩm</option>
                    </select>
                </div>
                <div class="mx-3">
                    <label for="groupBy" style="color:#3c57d2;"><strong>Nhóm theo:</strong></label>
                    <select class="form-control" style="width: 150px;" id="groupBy">
                        <option value="month">Tháng</option>
                        <option value="quarter">Quý</option>
                    </select>
                </div>
            </div>
            <canvas id="myChart" class="w-100"></canvas>
        </div>
        
    </div>
</div>

@section Scripts{
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        $(document).ready(function () {
            let rawData = [];
            let myChart;

            // Kiểm tra Chart.js đã load chưa
            if (typeof Chart === 'undefined') {
                console.error('Chart.js failed to load.');
                document.getElementById('error').textContent = 'Không thể tải Chart.js. Vui lòng kiểm tra kết nối.';
                return;
            }

            // Khởi tạo biểu đồ trống
            const ctx = document.getElementById('myChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: 'Doanh Thu Stacked Bar Chart'
                        }
                    },
                    responsive: true,
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Thời gian'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Doanh Thu (VNĐ)'
                            }
                        }
                    }
                }
            });

            // Gắn sự kiện onchange bằng jQuery (đảm bảo function đã tồn tại)
            $('#yearFilter, #quarterFilter, #monthFilter, #typeFilter, #groupBy').on('change', updateChart);

            // Gọi API để lấy dữ liệu
            function fetchData() {
                $.ajax({
                    url: 'https://localhost:7239/admin/doanhthu',
                    type: 'GET',
                    dataType: 'json',
                    success: function (json) {
                        console.log('Dữ liệu từ API:', json);

                        // Gán đúng dữ liệu từ json.data
                        rawData = Array.isArray(json.data) ? json.data : [];

                        // Gọi sau khi có dữ liệu
                        populateYearFilter(); // cập nhật năm trong filter
                        updateChart();        // cập nhật biểu đồ ngay khi trang load xong
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi API:', error);
                        document.getElementById('error').textContent = 'Không thể tải dữ liệu từ API.';
                    }
                });
            }

            // Đổ năm vào dropdown
            function populateYearFilter() {
                const yearFilter = document.getElementById('yearFilter');
                yearFilter.innerHTML = '<option value="all">Tất cả</option>';
                const years = [...new Set(rawData.map(item => item.nam))].sort((a, b) => a - b);
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearFilter.appendChild(option);
                });
                yearFilter.value = 'all';
            }

            // Cập nhật biểu đồ
            function updateChart() {
                const year = $('#yearFilter').val();
                const quarter = $('#quarterFilter').val();
                const month = $('#monthFilter').val();
                const type = $('#typeFilter').val();
                const groupBy = $('#groupBy').val();

                let filteredData = rawData;

                if (year !== 'all') filteredData = filteredData.filter(item => item.nam === parseInt(year));
                if (quarter !== 'all') filteredData = filteredData.filter(item => item.quy === parseInt(quarter));
                if (month !== 'all') filteredData = filteredData.filter(item => item.thang === parseInt(month));
                if (type !== 'all') filteredData = filteredData.filter(item => item.loai === type);

                const groupedData = filteredData.reduce((acc, item) => {
                    const key = groupBy === 'month'
                        ? `${item.nam}-${item.thang.toString().padStart(2, '0')}`
                        : `${item.nam}-Q${item.quy}`;
                    if (!acc[key]) acc[key] = { 'Dịch vụ': 0, 'Sản phẩm': 0 };
                    acc[key][item.loai] += item.doanhThu;
                    return acc;
                }, {});

                const labels = Object.keys(groupedData).sort();
                const dichVuData = labels.map(key => groupedData[key]['Dịch vụ'] || 0);
                const sanPhamData = labels.map(key => groupedData[key]['Sản phẩm'] || 0);

                myChart.data.labels = labels.map(label =>
                    groupBy === 'month'
                        ? `Tháng ${label.split('-')[1]} ${label.split('-')[0]}`
                        : `Quý ${label.split('-Q')[1]} ${label.split('-Q')[0]}`
                );

                myChart.data.datasets = [
                    {
                        label: 'Dịch vụ',
                        data: dichVuData,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Sản phẩm',
                        data: sanPhamData,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }
                ];

                myChart.update();
            }

            // Bắt đầu
            fetchData();
        });
    </script>


}